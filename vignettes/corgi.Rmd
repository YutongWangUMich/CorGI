---
title: "Pre-implantation embryo development in human and mouse"
author: "Yutong Wang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

We illustrate the CorGI feature selection method by analyzing datasets on human and mouse pre-implantation embryo development.

```{r}
library(corgi)
library(ggplot2)
```

# Load the data

We download the data from the [Hemberg Lab website](https://hemberg-lab.github.io/scRNA.seq.datasets/). The human dataset is from [Yan et al 2013](http://dx.doi.org/10.1038/nsmb.2660) while the mouse dataset is from [Deng et al 2014](http://dx.doi.org/10.1126/science.1245316).

```{r}
yan <- readRDS(url("https://scrnaseq-public-datasets.s3.amazonaws.com/scater-objects/yan.rds"))
deng <- readRDS(url("https://scrnaseq-public-datasets.s3.amazonaws.com/scater-objects/deng-reads.rds"))
```

# Preprocessing the data

Get genes common to both datasets
```{r}
rownames(yan) <- toupper(rownames(yan))
rownames(deng) <- toupper(rownames(deng))
shared_genes <- intersect(rownames(yan),rownames(deng))
```


Get rid of the spike-in genes
```{r}
shared_genes <- shared_genes[-grep("ERCC",shared_genes)]
```

Subset the data
```{r}
yan <- yan[shared_genes,]
deng <- deng[shared_genes,]
```

Normalize the data
```{r}
library(scran)
out <- multiBatchNorm(yan,deng,assay.type = "logcounts")

yan <- out[[1]]
deng <- out[[2]]
```

Combine the datasets
```{r}
X <- logcounts(yan)
Y <- logcounts(deng)

Z <- cbind(X,Y)
```

Perform PCA
```{r}
pc <- prcomp(t(Z),rank. = 2)$x
```

Prepare the meta data
```{r}
cell_type <- forcats::fct_c(as.factor(yan$cell_type1),as.factor(deng$cell_type1))
batch <- c(rep("Human",ncol(yan)),rep("Mouse",ncol(deng)))
```

# PCA plot

```{r}
qplot(pc[,1],pc[,2],color = cell_type,shape = batch)
```

# Run CorGI feature selection

```{r, eval = F}
corgi_output_embyro_devel <- run_corgi(X,Y)
```

```{r,eval=F,include=F}
devtools::use_data(corgi_output_embyro_devel,overwrite = T) # Cache the output so that we don't have to actually rerun corgi. Change to "eval=T" if rerun is necessary.
```

```{r,include=F}
data("corgi_output_embyro_devel") # Load the cached output
```

# Using the gene set produced by CorGI


```{r}
corgi_gene_set <- 
  union(select_top_corgi_genes(corgi_output_embyro_devel,n = 100,SVG_use = 2),
        select_top_corgi_genes(corgi_output_embyro_devel,n = 100,SVG_use = 3))

pc <- prcomp(t(Z[corgi_gene_set,]),rank. = 2)$x
qplot(pc[,1],pc[,2],color = cell_type,shape = batch)
```

