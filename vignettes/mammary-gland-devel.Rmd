---
title: "Mammary gland development"
author: "Yutong Wang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

```{r}
library(corgi)
library(scmap)
library(knitr) # for printing nice looking tables
library(ggplot2) # for creating pretty plots
library(cowplot) # for creating panel of plots
library(forcats) # for concatenating factors
library(scmap) # for the compared feature selection method
library(dplyr)
library(scran)
library(Matrix)
```


# Pal et al. 2017 dataset

```{r, eval = F}
con <- gzcon(
  url("https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE95434&format=file&file=GSE95434%5FGeneCounts%2Etxt%2Egz")
  )
txt <- readLines(con)
pal_raw <- read.table(file = textConnection(txt),header = T)

pal_raw[1:10,1:6]
pal <- SingleCellExperiment(assay = list(counts = as.matrix(pal_raw[,3:ncol(pal_raw)])))
dim(pal)
pal_entrezGeneID <- pal_raw[,1]
pal$cell_type <- 
  colnames(pal) %>% 
  lapply(FUN = function(x) strsplit(x,split = ".",fixed = T)[[1]][1]) %>%
  lapply(FUN = function(x) gsub(pattern = "X",replacement = "",x = x)) %>% 
  unlist %>%
  factor(levels = c("2wk","4wk","10wk"),ordered = T)

table(pal$cell_type)
# Change the names from entrezgene to mgi_symbol
features <- pal_entrezGeneID

library(biomaRt)
mart <- useMart("ensembl", 
                dataset = "mmusculus_gene_ensembl", 
                host="www.ensembl.org" )

out <- getBM(attributes = c("entrezgene", "mgi_symbol"), 
             values = features, 
             mart = mart,
             filters = "entrezgene")
head(out)
dim(out)
out$is_unique <- !duplicated(out$mgi_symbol)
out$is_nonempty <- out$mgi_symbol!=""
out_unique_nonempty <- out %>% filter(is_unique) %>% filter(is_nonempty)


# Just to be sure

any(duplicated(out_unique_nonempty$mgi_symbol))
any(out_unique_nonempty$mgi_symbol=="")

# Transform to MGI symbols

genes_use <- which(pal_entrezGeneID %in% out_unique_nonempty$entrezgene)

pal <- pal[genes_use,]

rownames(pal) <-
  plyr::mapvalues(
    x = pal_entrezGeneID[genes_use],
    from = out_unique_nonempty$entrezgene,
    to = out_unique_nonempty$mgi_symbol
  )
```

```{r, eval = F, include=F}
saveRDS(pal,file = "~/CorGI_RDS/MG_devel/pal.rds")
```


```{r, include=F}
pal <- readRDS(file = "~/CorGI_RDS/MG_devel/pal.rds")
```

# Giraddi et al. 2018 dataset

```{r, eval = F}
con <- gzcon(
  url("https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE111113&format=file&file=GSE111113%5FTable%5FS1%5FFilterNormal10xExpMatrix%2Etxt%2Egz"))
txt <- readLines(con)
giraddi_raw <- read.delim2(file = textConnection(txt))

head(colnames(giraddi_raw))
head(giraddi_raw$gene_id)
head(giraddi_raw$X) # the "X" column is where the MGI symbol for the gene names are stored

# remove duplicated MGI symbols
giraddi_raw <- giraddi_raw[!duplicated(giraddi_raw$X),]

# remove empty string names
giraddi_raw <- giraddi_raw[giraddi_raw$X!="",]

giraddi <- SingleCellExperiment(assay = list(counts = as.matrix(giraddi_raw[,4:ncol(giraddi_raw)])))
rownames(giraddi) <- giraddi_raw$X


giraddi$cell_type <- 
  lapply(strsplit(colnames(giraddi),split = "_"),function(x) x[1]) %>%
  as.character() %>%
  as.factor()

levels(giraddi$cell_type)

giraddi$cell_type <- plyr::mapvalues(
  x = giraddi$cell_type,
  from = levels(giraddi$cell_type),
  to = c("Adu", "Adu", "AduBas", "E16", "E18", "P4")
)
```

```{r, eval = F, include = F}
saveRDS(giraddi, file = "~/CorGI_RDS/MG_devel/giraddi.rds")
```


```{r, include = F}
giraddi <- readRDS(file = "~/CorGI_RDS/MG_devel/giraddi.rds")
```


```{r}
shared_genes <- intersect(rownames(pal),rownames(giraddi))
pal <- pal[shared_genes,]
giraddi <- giraddi[shared_genes,]
length(shared_genes)
```

Filter out cells where less than 5% of the genes are expressed
```{r}
table(pal$cell_type)
pal <- pal[,colMeans(counts(pal)>0)>0.05]
table(pal$cell_type)
```

```{r}
before <- table(giraddi$cell_type)
giraddi <- giraddi[,colMeans(counts(giraddi)>0)>0.05]
data.frame(before, after = as.numeric(table(giraddi$cell_type)))
```




```{r}
batches <- list(Pal = pal)
```


# CorGI feature selection on the Pal and Giraddi datasets
```{r,eval = F}
set.seed(0)
corgi_output_MG_devel <- run_corgi(counts(pal),
                                   counts(giraddi),
                                   time_per_phase = 60*60, 
                                   n_phases = 6)
```

```{r, eval = F,include=F}
devtools::use_data(corgi_output_MG_devel,
                   overwrite = T)
```

```{r, include=F}
data("corgi_output_MG_devel")
```


```{r, eval = T}
# stop()

corgi_res <- corgi_output_MG_devel[[6]]
corgi_scores <- corgi_res[,1:3]/corgi_res[,4]

gs <- rownames(corgi_res)
gene_loadings <- CCSpearman_GeneLoading(
  counts(giraddi)[gs, ], 
  counts(pal)[gs, ], 
  k = 3)

```

```{r}
top_n_genes((gene_loadings^2)[,3],500) -> cca_genes
# library(Seurat)
# gene_loadings <- Seurat_CCA_GeneLoading(
#   counts(giraddi)[gs, ], 
#   counts(pal)[gs, ]
#   )

gs <- intersect(rownames(gene_loadings), rownames(corgi_res))

df1 <- data.frame(scale(corgi_scores[gs, ]))
df2 <- data.frame(scale(gene_loadings[gs ,1:3]))
library(tidyr)
colnames(df1) <- paste0("corgi", 1:3)
colnames(df2) <- paste0("CC", 1:3)
plot_two_dfs(df1,df2) + 
  xlab("Singular value gap (CorGI)") + 
  ylab("Canonical correlation gene loading") +
  ggtitle("Mammary gland developmental datasets")
# stop()
```

# Curate the gene sets for comparison
```{r}
rowData(pal)$feature_symbols <- rownames(pal)
rowData(giraddi)$feature_symbols <- rownames(giraddi)
# corgi_gene_set <- union(
#   select_top_corgi_genes(corgi_output_MG_devel,n = 200, SVG_use = 2),
#   select_top_corgi_genes(corgi_output_MG_devel,n = 200, SVG_use = 3)
#   )
corgi_gene_set <- select_top_corgi_genes(corgi_output_MG_devel,n = 500)
# mbn = abbrev for multiBatchNorm
mbn_out <- multiBatchNorm(pal,giraddi)
```



```{r}
# corgi_gene_set <- cca_genes
HDG_ranking <- function(sce){
  rowData(sce)$feature_symbol <- rownames(sce)
  sce <- scmap::selectFeatures(sce)
  return(rownames(sce)[order(rowData(sce)[["scmap_scores"]],decreasing = T,na.last = T)])
}

n <- length(corgi_gene_set)

gene_sets <- get_compared_gene_sets(
  batch1_top_genes = HDG_ranking(mbn_out[[1]]),
  batch1_name = "HDG(Pal)",
  batch2_top_genes = HDG_ranking(mbn_out[[2]]), 
  batch2_name = "HDG(Giraddi)",
  desired_size = n)


gene_sets[["CorGI"]] <- corgi_gene_set
gene_sets <- gene_sets[c(5,1,2,3,4)]
gene_sets[["CCA"]] <- cca_genes
lapply(gene_sets, length)
stop()
```
```{r}
saveRDS(gene_sets, file = "~/CorGI_RDS/MG_devel/gene_sets.rds")
# stop()
```




Subsample the Giraddi dataset for visualization

```{r}
sample_cells <- function(object, n){
  return(object[,sample(1:ncol(object),n)])
}
set.seed(0)
giraddi <- sample_cells(giraddi,1000)
cell_type <- forcats::fct_c(giraddi$cell_type,pal$cell_type)
batch <- c(rep("Giraddi",ncol(giraddi)),rep("Pal",ncol(pal)))
combined <- cbind(counts(giraddi),counts(pal))
```

```{r}
mds <- spearman_rho_mds(combined[corgi_gene_set, ])
```


```{r}
my_shape_palette <- c(1,16)
my_color_palette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#000000")

qplot <- function(...){
  ggplot2::qplot(...) +
  scale_color_manual(values = my_color_palette) +
  scale_shape_manual(values = my_shape_palette)
}

qplot(mds[,1],mds[,2],color = cell_type,shape = batch)
```



# Wuidart et al. 2018 dataset

```{r, eval = F}
con <- gzcon(
  url("ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE110nnn/GSE110351/suppl/GSE110351_MG_EMP_LC_BC_raw_counts.csv.gz")
  )
txt <- readLines(con)
wuidart_raw <- read.csv(file = textConnection(txt))
wuidart_raw[1:5,1:5]
wuidart <- SingleCellExperiment(assay = list(counts = as.matrix(wuidart_raw[,2:ncol(wuidart_raw)])))
# First column of gse is the gene names
rownames(wuidart) <- wuidart_raw[,1]

# Remove the spike-ins

wuidart <- wuidart[grep("ENSMUSG",rownames(wuidart)),]

# Let us convert ENSEMBL to MGI symbols for the genes

head(rownames(wuidart))


# We need to remove the dots

f <- function(x){ strsplit(x,split = ".",fixed = T)[[1]][1] }
rownames(wuidart) <- unlist(lapply(rownames(wuidart), f))

# Does this cause any duplicates?

any(duplicated(rownames(wuidart)))


# Get the MGI symbols
out <- getBM(attributes = c("ensembl_gene_id", "mgi_symbol"), 
             values = rownames(wuidart), 
             mart = mart,
             filters = "ensembl_gene_id")

# Remove duplicates
out <- out[(!duplicated(out$ensembl_gene_id)) & (!duplicated(out$mgi_symbol)),]

wuidart <- wuidart[rownames(wuidart) %in% out$ensembl_gene_id,]

rownames(wuidart) <- plyr::mapvalues(rownames(wuidart),
                                     from = out$ensembl_gene_id,
                                     to = out$mgi_symbol)

# Now we need to get the metadata

library(GEOquery)
gse <- getGEO("GSE110351")
md_raw <- as.character(gse$GSE110351_series_matrix.txt.gz$title)
length(md_raw) == ncol(wuidart)
md <- data.frame(raw = md_raw,stringsAsFactors = F)


# The cell barcodes are the last 17 characters (including the dash)

md$raw[1:5]
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}
md$barcodes <- unlist(lapply(md$raw,function(x) substrRight(x,17)))
md$barcodes <- gsub("-",".",md$barcodes)
md <- md[order(md$barcodes),]
wuidart <- wuidart[,sort(colnames(wuidart))]
all(colnames(wuidart) == md$barcodes)

removeRight <- function(x, n){
  substr(x, 1, nchar(x)-n)
}
md$raw <- unlist(lapply(md$raw,function(x) removeRight(x,18)))
table(md$raw)

md$is_single_cell <- grepl("Single",md$raw)
md$cell_type <- NA
for(ct in c("Basal","Luminal","Embryonal Progenitor")){
  md$cell_type[grepl(ct,md$raw)] <- ct
}

wuidart$is_single_cell <- md$is_single_cell
wuidart$cell_type <- factor(md$cell_type)
wuidart <- wuidart[,wuidart$is_single_cell]

# Did we miss anything?

any(is.na(wuidart$cell_type))
plyr::mapvalues(
  x = wuidart$cell_type,
  from = c("Basal","Luminal","Embryonal Progenitor"),
  to =  c("Basal","Luminal","EMP")
) -> wuidart$cell_type
```

```{r, include = F, eval = F}
saveRDS(wuidart,file = "~/CorGI_RDS/MG_devel/wuidart.rds")
```

```{r, include = F}
wuidart <- readRDS(file = "~/CorGI_RDS/MG_devel/wuidart.rds")
batches[["Wuidart"]] <- wuidart
```


# Bach et al. 2017 dataset

Data from [Bach et al., 2017](https://www.nature.com/articles/s41467-017-02001-5)
```{r, eval = F}
bach_np1 <- readMM(gzcon(url("ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM2834nnn/GSM2834498/suppl/GSM2834498_NP_1_matrix.mtx.gz")))
dim(bach_np1)

bach_np2 <- readMM(gzcon(url("ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM2834nnn/GSM2834499/suppl/GSM2834499_NP_2_matrix.mtx.gz")))
dim(bach_np2)

"ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE106nnn/GSE106273/suppl/GSE106273_combined_genes.tsv.gz" %>%
  url %>% gzcon %>% readLines %>% textConnection %>% read.table(stringsAsFactors = F) ->
  bach_genes

bach_genes[1:5,]

rownames(bach_np1) <- bach_genes[,2]
rownames(bach_np2) <- bach_genes[,2]
```

```{r, eval = F, include = F}
saveRDS(bach_np1, file = "~/CorGI_RDS/MG_devel/bach_np1.rds")
saveRDS(bach_np2, file = "~/CorGI_RDS/MG_devel/bach_np2.rds")
```

```{r, include = F}
bach_np1 <- readRDS(file = "~/CorGI_RDS/MG_devel/bach_np1.rds")
bach_np2 <- readRDS(file = "~/CorGI_RDS/MG_devel/bach_np2.rds")
```



```{r}
set.seed(0)
bach_np1 <- sample_cells(bach_np1,500)
bach_np2 <- sample_cells(bach_np2,500)
bach_np <- cbind(bach_np1,bach_np2)

bach_np <- SingleCellExperiment(assay = list(counts = as.matrix(bach_np)))
```


From [Bach et al., 2017](https://www.nature.com/articles/s41467-017-02001-5): "Tissue from NP females was harvested at 8 weeks of age."
```{r}
bach_np$cell_type <- "8wk"
bach_np$cell_type <- factor(bach_np$cell_type)

batches[["Bach_NP"]] <- bach_np
```

# Reproducing the paper figures

For each batch, for each gene_set, compute dimensionality reductions, i.e., MNNPC and Spearman rho mds
```{r}
# Spearman rho multidimensional scaling
lapply(
  X = batches, # for each batch
  FUN = function(sce){
    shared_genes <- intersect(rownames(giraddi),rownames(sce))
    combined <- cbind(counts(giraddi[shared_genes,]),
                      counts(sce[shared_genes,]))
    lapply(
      X = gene_sets, # for each gene_sets
      FUN = function(gene_set) {
        gene_set <- intersect(gene_set, shared_genes)
        mds <- spearman_rho_mds(combined[gene_set, ])
        return(mds)
      }
    )
  }) -> embeddings_mds

# Mutual-nearest-neighbor PCA
lapply(
  X = batches,
  FUN = function(sce){
    shared_genes <- intersect(rownames(giraddi),rownames(sce))
    
    mbn_out <- multiBatchNorm(giraddi[shared_genes,],
                              sce[shared_genes,])
    
    lapply(
      X = gene_sets,
      FUN = function(gene_set) {
        gene_set <- intersect(gene_set, shared_genes)
        mnn.out <-
          mnnCorrect(logcounts(mbn_out[[1]][gene_set, ]),
                     logcounts(mbn_out[[2]][gene_set, ]))
        t.mnn <- as.matrix(t(do.call(cbind, mnn.out$corrected)))
        prcomp(t.mnn, rank = 2)$x
      }
    )
  }) -> embeddings_mnn
```

```{r, include = F}
saveRDS(embeddings_mds,file = "~/CorGI_RDS/MG_devel/embeddings_mds.rds")
saveRDS(embeddings_mnn,file = "~/CorGI_RDS/MG_devel/embeddings_mnn.rds")
```

```{r,include = F}
embeddings_mds <- readRDS(file = "~/CorGI_RDS/MG_devel/embeddings_mds.rds")
embeddings_mnn <- readRDS(file = "~/CorGI_RDS/MG_devel/embeddings_mnn.rds")
```


```{r}
get_scatterplots <- corgi::get_scatterplots
```


```{r}
color_palettes <-
  list(Pal = my_color_palette[6:8],
       Wuidart = my_color_palette[6:8],
       Bach_NP = my_color_palette[c(6)])


get_panel_for_dr <- function(embeddings_dr, emb_name,gene_sets_use){
  lapply(
    X = names(batches),
    FUN = function(batch_name) {
      sce <- batches[[batch_name]]
      cell_type <- forcats::fct_c(giraddi$cell_type,
                                  sce$cell_type)
      batch <-
        c(rep("Giraddi", ncol(giraddi)), rep(batch_name, ncol(sce)))
      batch <- factor(batch,levels = unique(batch))
      get_scatterplots(embeddings_dr[[batch_name]],
                       as.factor(batch),
                       cell_type) -> plts
      plts <- plts[gene_sets_use]
      get_color_legend(cell_type[batch == batch_name],
                       color_palettes[[batch_name]],
                       legend.title = batch_name) -> plts[[length(plts)+1]]
      plts[["nrow"]] <- 1
      plts[["rel_widths"]] <- c(rep(2,length(gene_sets_use)), 1)
      do.call(what = plot_grid, args = plts)
      
    }
  ) -> panel_rows
  
  get_color_legend(cell_type[batch == "Giraddi"],
                   my_color_palette,
                   legend.title = "Giraddi",
                   legend.position = "bottom",
                   shape = 1) ->
    giraddi_color_lgnd
  get_axes_legend(emb_name) -> axes_lgnd
  
  panel_rows[[4]] <-
    plot_grid(axes_lgnd,
              giraddi_color_lgnd,
              nrow = 1,
              rel_widths = c(1, 3))
  panel_rows[["labels"]] <- LETTERS[1:3]
  panel_rows[["nrow"]] <- 4
  panel_rows[["rel_heights"]] <- c(2, 2, 2, 1)
  
  do.call(what = plot_grid, args = panel_rows)
}
```

Main plots
```{r}
mnn_plots <- get_panel_for_dr(embeddings_mnn,"MNNPC",gene_sets_use = 1:3)
mds_plots <- get_panel_for_dr(embeddings_mds,"MDS",gene_sets_use = 1:3)
```

Multidimensional scaling plots
```{r,fig.width=6,fig.height=6}
mds_plots
```

Mutual-nearest-neighbor PCA plot
```{r,fig.width=6,fig.height=6}
mnn_plots
```

```{r, include = F}
ggsave(filename = "MG_devel_MNN.eps",device = "eps",plot = mnn_plots,path = "~/CorGI_figures/MG_devel",width = 8,height = 8)
ggsave(filename = "MG_devel_MDS.eps",device = "eps",plot = mds_plots,path = "~/CorGI_figures/MG_devel",width = 8,height = 8)
```

Supplementary plots
```{r}
mnn_plots <- get_panel_for_dr(embeddings_mnn,"MNNPC",gene_sets_use = 4:5)
mds_plots <- get_panel_for_dr(embeddings_mds,"MDS",gene_sets_use = 4:5)
```

Multidimensional scaling plots
```{r,fig.width=6,fig.height=6}
mds_plots
```

Mutual-nearest-neighbor PCA plot
```{r,fig.width=6,fig.height=6}
mnn_plots
```

```{r, include = F}
ggsave(filename = "MG_devel_MNN_backup.eps",device = "eps",plot = mnn_plots,path = "~/CorGI_figures/MG_devel",width = 8,height = 8)
ggsave(filename = "MG_devel_MDS_backup.eps",device = "eps",plot = mds_plots,path = "~/CorGI_figures/MG_devel",width = 8,height = 8)
```

