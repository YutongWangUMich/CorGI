---
title: "Mammary gland development"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

```{r}
library(corgi)
library(scmap)
library(knitr) # for printing nice looking tables
library(ggplot2) # for creating pretty plots
library(cowplot) # for creating panel of plots
library(forcats) # for concatenating factors
library(scmap) # for the compared feature selection method
library(dplyr)
library(scran)
library(GEOquery)
library(Matrix)
library(biomaRt)
mart <- useMart("ensembl", 
                dataset = "mmusculus_gene_ensembl", 
                host="www.ensembl.org" )
```

# Pal et al. 2017 dataset

```{r}
con <- gzcon(
  url("https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE95434&format=file&file=GSE95434%5FGeneCounts%2Etxt%2Egz")
  )
txt <- readLines(con)
pal_raw <- read.table(file = textConnection(txt),header = T)

pal_raw[1:10,1:6]
```

```{r}
pal <- SingleCellExperiment(assay = list(counts = as.matrix(pal_raw[,3:ncol(pal_raw)])))
dim(pal)
pal_entrezGeneID <- pal_raw[,1]
```

```{r}
pal$cell_type <- 
  colnames(pal) %>% 
  lapply(FUN = function(x) strsplit(x,split = ".",fixed = T)[[1]][1]) %>%
  lapply(FUN = function(x) gsub(pattern = "X",replacement = "",x = x)) %>% 
  unlist %>%
  factor(levels = c("2wk","4wk","10wk"),ordered = T)

table(pal$cell_type)
```


```{r}
# Change the names from entrezgene to mgi_symbol
features <- pal_entrezGeneID

out <- getBM(attributes = c("entrezgene", "mgi_symbol"), 
             values = features, 
             mart = mart,
             filters = "entrezgene")
head(out)
dim(out)
out$is_unique <- !duplicated(out$mgi_symbol)
out$is_nonempty <- out$mgi_symbol!=""
out_unique_nonempty <- out %>% filter(is_unique) %>% filter(is_nonempty)
```

Just to be sure
```{r}
any(duplicated(out_unique_nonempty$mgi_symbol))
any(out_unique_nonempty$mgi_symbol=="")
```

Transform to MGI symbols
```{r}
genes_use <- which(pal_entrezGeneID %in% out_unique_nonempty$entrezgene)

pal <- pal[genes_use,]

rownames(pal) <-
  plyr::mapvalues(
    x = pal_entrezGeneID[genes_use],
    from = out_unique_nonempty$entrezgene,
    to = out_unique_nonempty$mgi_symbol
  )
```


# Giraddi et al. 2018 dataset

```{r}
con <- gzcon(
  url("https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE111113&format=file&file=GSE111113%5FTable%5FS1%5FFilterNormal10xExpMatrix%2Etxt%2Egz"))
txt <- readLines(con)
giraddi_raw <- read.delim2(file = textConnection(txt))

head(colnames(giraddi_raw))
head(giraddi_raw$gene_id)
head(giraddi_raw$X) # the "X" column is where the MGI symbol for the gene names are stored

# remove duplicated MGI symbols
giraddi_raw <- giraddi_raw[!duplicated(giraddi_raw$X),]

# remove empty string names
giraddi_raw <- giraddi_raw[giraddi_raw$X!="",]

giraddi <- SingleCellExperiment(assay = list(counts = as.matrix(giraddi_raw[,4:ncol(giraddi_raw)])))
rownames(giraddi) <- giraddi_raw$X


giraddi$cell_type <- 
  lapply(strsplit(colnames(giraddi),split = "_"),function(x) x[1]) %>%
  as.character() %>%
  as.factor()

levels(giraddi$cell_type)

giraddi$cell_type <- plyr::mapvalues(
  x = giraddi$cell_type,
  from = levels(giraddi$cell_type),
  to = c("Adu", "Adu", "AduBas", "E16", "E18", "P4")
)
```


```{r}
shared_genes <- intersect(rownames(pal),rownames(giraddi))
pal <- pal[shared_genes,]
giraddi <- giraddi[shared_genes,]
length(shared_genes)
```

Filter out cells where less than 5% of the genes are expressed
```{r}
table(pal$cell_type)
pal <- pal[,colMeans(counts(pal)>0)>0.05]
table(pal$cell_type)
```

```{r}
table(giraddi$cell_type)
giraddi <- giraddi[,colMeans(counts(giraddi)>0)>0.05]
table(giraddi$cell_type)
```

# CorGI feature selection on the Pal and Giraddi datasets
```{r,eval= F}
corgi_output_MG_devel <- run_corgi(counts(pal),counts(giraddi))
```

```{r, eval = F,include=F}
devtools::use_data(corgi_output_MG_devel)
```

```{r, include=F}
data("corgi_output_MG_devel")
```


# Subsample the Giraddi dataset for visualization

```{r}
sample_cells <- function(object, n){
  return(object[,sample(1:ncol(object),n)])
}
giraddi <- sample_cells(giraddi,1000)
cell_type <- forcats::fct_c(giraddi$cell_type,pal$cell_type)
batch <- c(rep("Giraddi",ncol(giraddi)),rep("Pal",ncol(pal)))
comb <- cbind(counts(giraddi),counts(pal))
```

```{r}
corgi_gene_set <- select_top_corgi_genes(corgi_output_MG_devel,n = 1000)
D <- (1-cor(comb[corgi_gene_set,],method = "spearman"))/2
mds <- cmdscale(D,k=2)
```


```{r}

qplot(mds[,1],mds[,2],color = cell_type,shape = batch) + 
  scale_shape_manual(values = c(1,16)) + 
  scale_color_manual(values = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7"))

```


```{r}
rowData(pal)$feature_symbols <- rownames(pal)
rowData(giraddi)$feature_symbols <- rownames(giraddi)
out <- multiBatchNorm(pal,giraddi)

pal <- out[[1]]
giraddi <- out[[2]]

```


```{r}
pal <- selectFeatures(pal)
giraddi <- selectFeatures(giraddi)

top_HDG <- function(sce){
  return(rownames(sce)[order(rowData(sce)[["scmap_scores"]],decreasing = T,na.last = T)])
}

pal_top_HDG <- top_HDG(pal)
giraddi_top_HDG <- top_HDG(giraddi)

n <- length(corgi_gene_set)

gene_sets <- get_compared_gene_sets(
  batch1_top_genes = pal_top_HDG,
  batch1_name = "HDG(Pal)",
  batch2_top_genes = giraddi_top_HDG, 
  batch2_name = "HDG(Giraddi)",
  desired_size = n)


gene_sets[["CorGI"]] <- corgi_gene_set

lapply(gene_sets, length)
```


```{r}
my_shape_palette <- scale_shape_manual(values = c(1,16))
my_color_palette <- scale_color_manual(values = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7"))
get_scatterplots <- function(embeddings, batch, cell_type){
  lapply(X = names(gene_sets),
         FUN = function(gs_name) {
           emb <- embeddings[[gs_name]]
           plot_dimensionality_reduction(emb, batch, cell_type) +
             my_shape_palette +
             my_color_palette + 
             ggtitle(paste0(gs_name, ", ", round(corgi::batch_mixing(emb, batch), 2)))
         })
}

```


```{r}
emb_name <- "MDS"

embeddings <- 
  lapply(
    X = gene_sets,
    FUN = function(gene_set) {
      D <- (1 - cor(comb[gene_set, ], method = "spearman")) / 2
      return(cmdscale(D, k = 2))
    }
  )
```

```{r}
get_scatterplots(embeddings,batch,cell_type) -> giraddi_pal_plts

get_axes_legend("MDS") -> axes_lgnd


get_shape_legend(batch,my_shape_palette) -> shape_lgnd
get_color_legend(cell_type[batch == "Giraddi"],
                 scale_color_manual(values = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442")),
                 legend.position = "bottom",legend.title = "Giraddi",ncol=2) ->
  giraddi_color_lgnd
get_color_legend(cell_type[batch == "Pal"],
                 scale_color_manual(values = c( "#0072B2", "#D55E00", "#CC79A7")),
                 legend.title = "Pal") -> pal_color_lgnd

giraddi_pal_plts[[6]] <- plot_grid(plot_grid(axes_lgnd,pal_color_lgnd),giraddi_color_lgnd,nrow=2)


do.call(plot_grid,giraddi_pal_plts)
```




# Wuidart et al. 2018 dataset

## Data cleaning
```{r}
con <- gzcon(
  url("ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE110nnn/GSE110351/suppl/GSE110351_MG_EMP_LC_BC_raw_counts.csv.gz")
  )
txt <- readLines(con)
wuidart_raw <- read.csv(file = textConnection(txt))
wuidart_raw[1:5,1:5]
```

```{r}
wuidart <- SingleCellExperiment(assay = list(counts = as.matrix(wuidart_raw[,2:ncol(wuidart_raw)])))
# First column of gse is the gene names
rownames(wuidart) <- wuidart_raw[,1]
```


Remove the spike-ins
```{r}
wuidart <- wuidart[grep("ENSMUSG",rownames(wuidart)),]
```

Let us convert ENSEMBL to MGI symbols for the genes
```{r}
head(rownames(wuidart))
```

We need to remove the dots
```{r}
f <- function(x){ strsplit(x,split = ".",fixed = T)[[1]][1] }
rownames(wuidart) <- unlist(lapply(rownames(wuidart), f))
```

Does this cause any duplicates?
```{r}
any(duplicated(rownames(wuidart)))
```


```{r}
# Get the MGI symbols
out <- getBM(attributes = c("ensembl_gene_id", "mgi_symbol"), 
             values = rownames(wuidart), 
             mart = mart,
             filters = "ensembl_gene_id")

# Remove duplicates
out <- out[(!duplicated(out$ensembl_gene_id)) & (!duplicated(out$mgi_symbol)),]

wuidart <- wuidart[rownames(wuidart) %in% out$ensembl_gene_id,]

rownames(wuidart) <- plyr::mapvalues(rownames(wuidart),
                                     from = out$ensembl_gene_id,
                                     to = out$mgi_symbol)
```


Now we need to get the metadata
```{r}
gse <- getGEO("GSE110351")
md_raw <- as.character(gse$GSE110351_series_matrix.txt.gz$title)
length(md_raw) == ncol(wuidart)
md <- data.frame(raw = md_raw,stringsAsFactors = F)
```

The cell barcodes are the last 17 characters (including the dash)
```{r}
md$raw[1:5]
```

```{r}
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}
md$barcodes <- unlist(lapply(md$raw,function(x) substrRight(x,17)))
md$barcodes <- gsub("-",".",md$barcodes)
md <- md[order(md$barcodes),]
wuidart <- wuidart[,sort(colnames(wuidart))]
all(colnames(wuidart) == md$barcodes)
```

```{r}
removeRight <- function(x, n){
  substr(x, 1, nchar(x)-n)
}
md$raw <- unlist(lapply(md$raw,function(x) removeRight(x,18)))
table(md$raw)
```

```{r}
md$is_single_cell <- grepl("Single",md$raw)
md$cell_type <- NA
for(ct in c("Basal","Luminal","Embryonal Progenitor")){
  md$cell_type[grepl(ct,md$raw)] <- ct
}
```



```{r}
wuidart$is_single_cell <- md$is_single_cell
wuidart$cell_type <- factor(md$cell_type)
wuidart <- wuidart[,wuidart$is_single_cell]
```

Did we miss anything?
```{r}
any(is.na(wuidart$cell_type))
```


```{r}
shared_genes <- intersect(rownames(giraddi),rownames(wuidart))
length(shared_genes)

cell_type <- forcats::fct_c(giraddi$cell_type,wuidart$cell_type)
batch <- c(rep("Giraddi",ncol(giraddi)),rep("Wuidart",ncol(wuidart)))

comb <- cbind(counts(giraddi[shared_genes,]),
              counts(wuidart[shared_genes,]))

emb_name <- "MDS"

embeddings <- 
  lapply(
    X = gene_sets,
    FUN = function(gene_set) {
      D <- (1 - cor(comb[intersect(gene_set,shared_genes), ], method = "spearman")) / 2
      return(cmdscale(D, k = 2))
    }
  )
```
```{r}
get_scatterplots(embeddings,batch,cell_type) -> giraddi_wuidart_plts

get_axes_legend("MDS") -> axes_lgnd


get_shape_legend(batch,my_shape_palette) -> shape_lgnd

get_color_legend(cell_type[batch == "Wuidart"],
                 scale_color_manual(values = c( "#0072B2", "#D55E00", "#CC79A7")),
                 legend.title = "Wuidart",legend.position = "top") -> wuidart_color_lgnd

giraddi_wuidart_plts[[6]] <- plot_grid(plot_grid(axes_lgnd,wuidart_color_lgnd),giraddi_color_lgnd,nrow=2)


do.call(plot_grid,giraddi_wuidart_plts)
```



# Bach et al. 2017 dataset


```{r}
bach_np1 <- readMM(gzcon(url("ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM2834nnn/GSM2834498/suppl/GSM2834498_NP_1_matrix.mtx.gz")))
dim(bach_np1)

bach_np2 <- readMM(gzcon(url("ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM2834nnn/GSM2834499/suppl/GSM2834499_NP_2_matrix.mtx.gz")))
dim(bach_np2)

"ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE106nnn/GSE106273/suppl/GSE106273_combined_genes.tsv.gz" %>%
  url %>% gzcon %>% readLines %>% textConnection %>% read.table(stringsAsFactors = F) ->
  bach_genes

bach_genes[1:5,]

bach_np1 <- sample_cells(bach_np1,500)
bach_np2 <- sample_cells(bach_np2,500)
bach_np <- cbind(bach_np1,bach_np2)

bach_np <- SingleCellExperiment(assay = list(counts = as.matrix(bach_np)))
rownames(bach_np) <- bach_genes[,2]


bach_np$cell_type <- "Adu"
bach_np$cell_type <- factor(bach_np$cell_type)
```


```{r}
shared_genes <- intersect(rownames(giraddi),rownames(bach_np))
length(shared_genes)

cell_type <- forcats::fct_c(giraddi$cell_type,bach_np$cell_type)
batch <- c(rep("Giraddi",ncol(giraddi)),rep("Bach_NP",ncol(bach_np)))

comb <- cbind(counts(giraddi[shared_genes,]),
              counts(bach_np[shared_genes,]))

emb_name <- "MDS"

embeddings <- 
  lapply(
    X = gene_sets,
    FUN = function(gene_set) {
      D <- (1 - cor(comb[intersect(gene_set,shared_genes), ], method = "spearman")) / 2
      return(cmdscale(D, k = 2))
    }
  )
```

```{r}
get_scatterplots(embeddings,batch,cell_type) -> giraddi_bach_NP_plts

get_axes_legend("MDS") -> axes_lgnd


get_shape_legend(batch,my_shape_palette) -> shape_lgnd

get_color_legend(cell_type[batch == "Bach_NP"],
                 scale_color_manual(values = c( "#999999")),
                 legend.title = "Bach_NP",legend.position = "top") -> Bach_NP_color_lgnd

giraddi_bach_NP_plts[[6]] <- plot_grid(plot_grid(axes_lgnd,Bach_NP_color_lgnd),giraddi_color_lgnd,nrow=2)


do.call(plot_grid,giraddi_bach_NP_plts)

```


```{r,fig.height=8}

giraddi_bach_NP_plts[[6]] <- Bach_NP_color_lgnd
giraddi_bach_NP_plts[["ncol"]] <- 1
giraddi_bach_NP_plts[["rel_heights"]] <- c(1,2,2,2,2,2)

do.call(plot_grid,rev(giraddi_bach_NP_plts)) -> bach_np_panel



giraddi_wuidart_plts[[6]] <- wuidart_color_lgnd
giraddi_wuidart_plts[["ncol"]] <- 1
giraddi_wuidart_plts[["rel_heights"]] <- c(1,2,2,2,2,2)

do.call(plot_grid,rev(giraddi_wuidart_plts)) -> wuidart_panel


giraddi_pal_plts[[6]] <- pal_color_lgnd
giraddi_pal_plts[["ncol"]] <- 1
giraddi_pal_plts[["rel_heights"]] <- c(1,2,2,2,2,2)

do.call(plot_grid,rev(giraddi_pal_plts)) -> pal_panel

plot_grid(pal_panel,wuidart_panel,bach_np_panel,ncol=3)


# plot_grid(wuidart_panel,bach_np_panel)

```

