---
title: "Liver bud development"
author: "Yutong Wang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

In this vignette, we analyze the liver bud dataset from [Camp et al 2017](https://www.nature.com/articles/nature22796)

```{r}
library(corgi)
library(knitr)
library(ggplot2)
library(forcats)
```

# Preprocessing the datasets

Download from GSE and view the top-left corner of the data table
```{r}
con <- gzcon(
  url("ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE81nnn/GSE81252/suppl/GSE81252_data.cast.log2.liverbud.csv.gz")
  )
txt <- readLines(con)
liverbud <- read.csv(file = textConnection(txt))
kable(liverbud[1:10,1:6])
```

The first three columns are metadata while the rest are the log2 expression
```{r}
metadata <- liverbud[,1:3]
counts <- t(as.matrix(liverbud[,4:ncol(liverbud)]))
```

```{r}
colnames(counts) <- metadata$cell_id
rownames(metadata) <- metadata$cell_id
```

## Metadata

Whether a cell came from the liver bud or the input cell lines
```{r}
metadata$LB_status <- 
  unlist(lapply(X = metadata$assignment_LB,
                FUN = function(x) ifelse(test = grepl("LB",x),yes = "Liver_bud",no = "Input")
                ))
```

The original cell line identity
```{r}
metadata$lineage <- 
  factor(unlist(
    lapply(X = metadata$assignment_LB,
           FUN = function(x) strsplit(as.character(x),split = "-",fixed = T)[[1]][1])
    ))
levels(metadata$lineage)
```
EC = endothelial cells, HE = hepatic endoderm, MC = mesenchymal cells


## Overview of the datasets
```{r}
kable(table(metadata$lineage,metadata$LB_status))
```


## Convert to `SingleCellExperiment` objects
```{r}
library(scran)
camp <- SingleCellExperiment(assays = list(logcounts = counts),colData = metadata)

IN <- camp[,camp$LB_status=="Input"]
LB <- camp[,camp$LB_status=="Liver_bud"]
```

## Normalization
```{r}
out <- scran::multiBatchNorm(IN,LB,assay.type = "logcounts")
IN <- out[[1]]
LB <- out[[2]]
```

Combine the datasets
```{r}
combined <- cbind(logcounts(IN),logcounts(LB))
lineage <- fct_c(IN$lineage,LB$lineage)
batch <- c(rep("Input",ncol(IN)),rep("Liver bud",ncol(LB)))
```

## Compute PCA using all genes
```{r}
pc <- prcomp(t(combined),rank. = 2)$x
```

## PC plot using all the genes

```{r}
qplot(pc[,1],pc[,2],color = lineage,shape = batch)
```

# CorGI unsupervised feature selection
```{r, eval = F}
res_list_liver_bud <- run_corgi(logcounts(IN),logcounts(LB))
```

## Selecting the top CorGI genes

```{r}
data("res_list_liver_bud")
corgi_gene_set <- select_top_corgi_genes(res_list_liver_bud,300)
```


## PCA on CorGI genes

```{r}
pc <- prcomp(t(combined[corgi_gene_set,]),rank. = 2)$x
qplot(pc[,1],pc[,2],color = lineage,shape = batch)
```

# Comparison

```{r}
library(scmap)
rowData(IN)[["feature_symbol"]] <- rownames(IN)
IN <- selectFeatures(IN,n_features = 100)

rownames(IN)[rowData(IN)[["scmap_features"]]]
```

